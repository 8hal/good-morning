# 서비스 개선 계획

## 1. Start 화면 개선: 대화형 온보딩

### 현재 문제
- AI가 즉시 루틴을 제안하지만, 사용자의 현재 상태를 충분히 파악하지 못함
- 재택/출근, 앵커 타임, 컨디션 등을 **사용자가 수동으로 수정**해야 함

### 개선 방향
AI가 먼저 질문하고, 답변을 받은 후 맞춤형 루틴을 제안하는 **대화형 온보딩** 도입

### 대화 흐름 예시
```
AI: 안녕하세요! 오늘 하루를 준비해볼까요? 
    먼저 몇 가지 여쭤볼게요.

AI: 1️⃣ 오늘은 출근하시나요, 재택 근무인가요?
    [출근] [재택]

User: [재택] 선택

AI: 2️⃣ 출근 시간이 10시가 맞나요?
    [맞아요] [아니요, 다른 시간]

User: [아니요, 다른 시간]

AI: 몇 시에 출근하시나요?
    [시간 입력 or 음성]

User: "11시"

AI: 3️⃣ 오늘 컨디션은 어떠신가요?
    [좋음 😊] [보통 😐] [피곤함 😴] [매우 피곤함 😩]

User: [피곤함 😴]

AI: 알겠습니다! 재택 근무에 11시 출근, 약간 피곤하시군요.
    아침을 여유롭게 보낼 수 있도록 루틴을 준비했어요.
    
    [루틴 카드 표시]
```

### 구현 사항
1. **MorningAssistantService 개선**
   - `startConversation()`: 첫 인사 + 첫 번째 질문 반환
   - `answerQuestion(answer)`: 답변 받고 다음 질문 or 최종 루틴 제안
   - 대화 상태 관리: `ConversationState` (질문 단계, 수집된 정보)

2. **UI 변경**
   - 초기 로딩 시 즉시 루틴 표시 대신, **대화 인터페이스** 표시
   - 질문별 UI 컴포넌트:
     - 출근/재택: SegmentedButton
     - 시간: TimePicker
     - 컨디션: 이모지 버튼 그리드
   - 대화 완료 후 → 기존 `SuggestionCard` 표시

3. **컨텍스트 활용**
   - 마지막 세션 정보로 기본값 추론 (예: 어제 출근 → 오늘도 출근일 가능성 높음)
   - 사용자 히스토리 기반 개인화 (예: 평소 10시 출근 → 기본값 10시)

---

## 2. History 화면 UX 설계

### 요구사항
- 과거 세션 목록 조회
- 세션별 상세 정보 (시작/종료 시간, 실행한 블록, 피드백 등)
- 통계 및 인사이트 (주간/월간)

### 화면 구조

#### 2.1. History 메인 화면 (목록)
```
[📅 2026년 2월]

🌅 오늘 (2월 16일 일요일)
┌─────────────────────────────┐
│ 06:30 - 09:45 (3시간 15분)   │
│ ✓ 5개 블록 완료              │
│ 😊 컨디션: 좋음              │
│ 📊 예상보다 15분 일찍 완료    │
└─────────────────────────────┘
[상세보기 >]

어제 (2월 15일 토요일)
┌─────────────────────────────┐
│ 07:00 - 10:20 (3시간 20분)   │
│ ✓ 6개 블록 완료              │
│ 😐 컨디션: 보통              │
└─────────────────────────────┘
[상세보기 >]

[이번 주 통계 보기]
```

#### 2.2. History 상세 화면
```
📅 2월 16일 일요일

⏰ 세션 정보
- 시작: 06:30
- 종료: 09:45
- 소요 시간: 3시간 15분
- 예상 시간: 3시간 30분 (-15분)

✅ 완료한 블록 (5개)
1. [06:30-06:45] 명상 (15분)
   ⭐⭐⭐⭐⭐ "집중하기 좋았어요"
2. [06:45-07:15] 운동 (30분)
   ⭐⭐⭐⭐☆ "조금 힘들었지만 완료"
3. [07:15-07:45] 샤워 (30분)
4. [07:45-08:15] 아침 식사 (30분)
5. [08:15-09:45] 이동 시간 (90분)
   📍 출근 (재택 아님)

😊 오늘의 컨디션: 좋음
💬 전체 회고: "아침을 일찍 시작해서 여유로웠어요"
```

#### 2.3. 주간/월간 통계 화면
```
📊 이번 주 통계 (2/10 - 2/16)

⏱️ 평균 소요 시간
- 평균: 3시간 18분
- 최단: 2시간 45분 (2/12)
- 최장: 3시간 50분 (2/14)

✅ 블록 완료율
██████████ 100% 명상 (7/7)
████████░░  85% 운동 (6/7)
██████████ 100% 샤워 (7/7)
██████████ 100% 아침 식사 (7/7)

😊 컨디션 분포
좋음:   ███░░ 3일
보통:   ████░ 4일
피곤함: ░░░░░ 0일

🎯 인사이트
- 운동 블록을 건너뛴 날(2/13)은 오후에 피로도가 높았어요
- 명상 후 운동한 날이 컨디션이 더 좋았어요
```

### DB 스키마 (필요한 필드)
```dart
class Session {
  String id;
  String uid;
  DateTime startAt;
  DateTime? endAt;
  int estimatedMinutes;   // 예상 소요 시간
  int? actualMinutes;     // 실제 소요 시간
  String condition;       // "good", "normal", "tired", "very_tired"
  String? reflection;     // 전체 회고
  List<CompletedBlock> completedBlocks;
}

class CompletedBlock {
  String presetId;
  DateTime startedAt;
  DateTime completedAt;
  int rating;            // 1-5 별점
  String? feedback;      // 블록별 피드백
}
```

### 구현 우선순위
1. **Phase 1** (필수):
   - History 목록 화면 (기본 정보만)
   - 세션 상세 화면 (블록 목록, 시간)

2. **Phase 2** (권장):
   - 주간 통계 (평균 시간, 완료율)
   - 컨디션 기록 기능

3. **Phase 3** (선택):
   - 월간 통계
   - AI 인사이트

---

## 구현 계획

### Step 1: 대화형 온보딩 (Start 화면)
- [ ] `ConversationState` 모델 생성
- [ ] `MorningAssistantService.startConversation()` 구현
- [ ] `MorningAssistantService.answerQuestion()` 구현
- [ ] Start 화면에 대화 UI 추가 (질문별 입력 위젯)
- [ ] 대화 완료 후 루틴 카드로 전환
- [ ] Gemini 프롬프트 수정 (대화형 흐름)

### Step 2: History 화면 (Phase 1)
- [ ] `Session` 모델에 `condition`, `reflection` 필드 추가
- [ ] `CompletedBlock` 모델에 `rating`, `feedback` 필드 추가
- [ ] History 화면 라우팅 추가 (`/history`)
- [ ] History 목록 화면 구현
- [ ] History 상세 화면 구현
- [ ] 하단 네비게이션 바에 History 탭 추가

### Step 3: 컨디션 & 회고 입력 (세션 종료 시)
- [ ] 세션 종료 시 컨디션 입력 UI
- [ ] 블록별 별점 & 피드백 입력 UI
- [ ] 전체 회고 입력 UI
- [ ] Firestore에 저장

### Step 4: 통계 화면 (Phase 2)
- [ ] 주간 통계 계산 로직
- [ ] 주간 통계 화면 구현
- [ ] 평균 시간, 완료율, 컨디션 분포 차트

---

## 다음 액션

어떤 개선사항부터 시작할까요?

1. **대화형 온보딩** - Start 화면 개선
2. **History 화면** - 과거 기록 조회
3. **둘 다 동시 진행** (병렬 작업)

선택해주시면 바로 작업 시작하겠습니다.
